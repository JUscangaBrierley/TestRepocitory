<?xml version="1.0" encoding="utf-8"?>
<DAPDirectives xmlns="http://www.brierley.com/DAPFileProcessing">
  <!-- General Configuration Parameters -->
  <DAPConfiguration>
    <Organization>AmericanEagle</Organization>
    <Environment>DevelopmentBline</Environment>
    <DAPDataType>GlobalAttributeSets</DAPDataType>
    <DateConversionFormat></DateConversionFormat>
    <TrimStrings>true</TrimStrings>
    <EmailInformation>
      <SMTPServer>cypwebmail.brierleyweb.com</SMTPServer>
      <SenderEmail>aejobs@brierley.com</SenderEmail>
      <SenderDisplayName>AE DAP Processor</SenderDisplayName>
      <RecepientEmail>aerewards_support@brierley.com</RecepientEmail>
      <Subject>Vendor Email Rewards Statement (Stage) DAP Processor</Subject>
    </EmailInformation>
    <DoNotProcess>false</DoNotProcess>
  </DAPConfiguration>
  <!-- Configuration parameters for message acquisition -->
  <InputProvider MessageProcessingScheme="Single" DebugOutputPath="E:\LoyaltyWare\DevRoot\AmericanEagle\Dummy\Stage1">
    <SimpleDatabaseInput CollectionName="VendorEmailRewards" RecordName="VendorEmailReward">
      <QueryString>
        Select 0 as rownumber
        , CAST('DELIVERY_CHANNEL' as NVARCHAR2(100))  DELIVERY_CHANNEL
        , CAST('CUSTOMER_NBR' as NVARCHAR2(100))  CUSTOMER_NBR
        , CAST('LOYALTY_NUMBER' as NVARCHAR2(100))  LOYALTY_NUMBER
        , CAST('EMAIL' as NVARCHAR2(150))  EMAIL
        , CAST('MOBILE_NUMBER' as NVARCHAR2(100))  MOBILE_NUMBER
        , CAST('FNAME' as NVARCHAR2(100))  FNAME
        , CAST('LNAME' as NVARCHAR2(100))  LNAME
        , CAST('ADDRESS1' as NVARCHAR2(100))  ADDRESS1
        , CAST('ADDRESS2' as NVARCHAR2(100))  ADDRESS2
        , CAST('CITY' as NVARCHAR2(100))  CITY
        , CAST('STATE' as NVARCHAR2(100))  STATE
        , CAST('ZIP' as NVARCHAR2(100))  ZIP
        , CAST('COUNTRY' as NVARCHAR2(100))  COUNTRY
        , CAST('AUTH_CD' as NVARCHAR2(100))  N3_DIGIT_REWARDS_CODE
        , CAST('SUC_CD' as NVARCHAR2(100))  N20_DIGIT_REWARD_CODE
        , CAST('CAMPAIGN_TYPE' as NVARCHAR2(100))  REWARD_TYPE
        , CAST('CAMPAIGN_EXP_DATE' as NVARCHAR2(100))  REWARD_EXP_DATE
        , CAST('EID' as NVARCHAR2(100))  EID
        , CAST('CAMPAIGN_ID' as NVARCHAR2(100))   CAMPAIGN_ID
        , CAST('LANGUAGE_PREFERENCE' as NVARCHAR2(100))  LANGUAGE_PREFERENCE
        , CAST('GENDER' as NVARCHAR2(100))   GENDER
        , CAST('BIRTHDATE' as NVARCHAR2(100))  BIRTHDATE
        , CAST('STORE_LOYALTY' as NVARCHAR2(100))  STORE_LOYALTY
        , CAST('TIER_STATUS' as NVARCHAR2(100))  TIER_STATUS
        , CAST('POINTS_BALANCE' as NVARCHAR2(100))  POINTS_BALANCE
        , CAST('POINTS_NEEDED_FOR_NEXT_REWARD' as NVARCHAR2(100))  POINTS_NEEDED_FOR_NEXT_REWARD
        , CAST('NUMBER_OF_BRAS_PURCHASED' as NVARCHAR2(100))  NUMBER_OF_BRAS_PURCHASED
        , CAST('CREDITS_TO_NEXT_FREE_BRA' as NVARCHAR2(100))  CREDITS_TO_NEXT_FREE_BRA
        , CAST('NUMBER_OF_JEANS_PURCHASED' as NVARCHAR2(100))  NUMBER_OF_JEANS_PURCHASED
        , CAST('CREDITS_TO_NEXT_FREE_JEAN' as NVARCHAR2(100))  CREDITS_TO_NEXT_FREE_JEAN
        , CAST('NUMBER_OF_ACTIVE_5_OFF_REWARD' as NVARCHAR2(100))  NUMBER_OF_ACTIVE_5_OFF_REWARD
        , CAST('NUMBER_OF_ACTIVE_FREE_JEANS_REWARD' as NVARCHAR2(100))  NUMBER_OF_ACTIVE_FREE_JEANS
        , CAST('NUMBER_OF_ACTIVE_FREE_BRA_REWARD' as NVARCHAR2(100))  NUMBER_OF_ACTIVE_FREE_BRA
        , CAST('COMMUNICATION_ID' as NVARCHAR2(100))  COMMUNICATION_ID
        , CAST('COMM_PLAN_ID' as NVARCHAR2(100))  COMM_PLAN_ID
        , CAST('COLLATERAL_ID' as NVARCHAR2(100))  COLLATERAL_ID
        , CAST('PACKAGE_ID' as NVARCHAR2(100))  PACKAGE_ID
        , CAST('STEP_ID' as NVARCHAR2(100))  STEP_ID
        , CAST('MESSAGE_ID' as NVARCHAR2(100))  MESSAGE_ID
        , CAST('SEG_ID' as NVARCHAR2(100))  SEG_ID
        , CAST('SEG_NM' as NVARCHAR2(100))  SEG_NM
        , CAST('AAP_FLAG' as NVARCHAR2(100))  AAP_FLAG
        , CAST('CARD_TYPE' as NVARCHAR2(100))  CARD_TYPE
        , CAST('RUN_ID' as NVARCHAR2(100))  RUN_ID
        , CAST('LEAD_KEY_ID' as NVARCHAR2(100))  LEAD_KEY_ID
        , CAST('SITE_URL' as NVARCHAR2(100))  SITE_URL
        , CAST('ENABLE_PASSBOOK_PASS' as NVARCHAR2(100))  ENABLE_PASSBOOK_PASS
        , CAST('TIMESTAMP' as NVARCHAR2(100))  TIMESTAMP
        From Dual
        Union
        SELECT 1 as rownumber
        , CAST(1 as NVARCHAR2(80)) -- Delivery Channel
        , CAST(vc.linkkey as NVARCHAR2(80)) -- CUSTOMER_NBR
        , CAST(vc.loyaltyidnumber  as NVARCHAR2(100))-- LOYALTY_NUMBER
        , CAST(md.a_emailaddress  as NVARCHAR2(150))-- EMAIL
        , regexp_replace( CAST(md.a_mobilephone  as NVARCHAR2(100)), '[^[:digit:]]', null ) MOBILE_NUMBER  -- AEO-350
        , CAST(lm.firstname  as NVARCHAR2(100))-- FNAME
        , CAST(lm.lastname  as NVARCHAR2(100))-- LNAME
        , CAST(md.a_addresslineone  as NVARCHAR2(100))-- Address1
        , CAST(md.a_addresslinetwo  as NVARCHAR2(100))-- Address2
        , CAST(md.a_city  as NVARCHAR2(100))-- City
        , CAST(md.a_stateorprovince  as NVARCHAR2(100))-- STATE
        , CAST(REPLACE(md.a_ziporpostalcode, '-')   as NVARCHAR2(100))-- ZIP
        , CAST(md.a_country  as NVARCHAR2(100))-- Region (Country)
        , CAST(''  as NVARCHAR2(100))-- 3 Digit Rewards Code
        , CAST(''  as NVARCHAR2(100))-- 20 Digit Reward Code
        , CAST(''  as NVARCHAR2(100))-- Reward Type (Mobile Event Type)
        , CAST(''  as NVARCHAR2(100))-- REWARD_EXP_DATE
        , (select CAST(to_char(value) as NVARCHAR2(100)) from lw_clientconfiguration cc where cc.ckey = 'EID_EmailRewardStatements') -- eid
        , CAST('' as NVARCHAR2(100)) -- Campaign ID
        , CASE
        WHEN md.a_languagepreference is NULL THEN CAST(0 as NVARCHAR2(100))
        ELSE CAST(md.a_languagepreference as NVARCHAR2(100))
        END -- Language Preference
        , CAST(to_char(NVL(md.a_gender, '0')) as NVARCHAR2(100)) -- GENDER
        , CAST( to_char(lm.birthdate, 'DD-MON-YYYY') as NVARCHAR2(100)) -- BIRTH_MONTH (Birthday?)
        , CAST( md.a_homestoreid as NVARCHAR2(80)) -- STORE_LOYALTY
        , (SELECT
        Case
        When t.tiername = 'Blue' Then CAST(1 as NVARCHAR2(100))
        When t.tiername = 'Silver' Then CAST(2 as NVARCHAR2(100))
        When t.tiername = 'Gold' Then CAST(3 as NVARCHAR2(100))
        When t.tiername = 'Select' Then CAST(4 as NVARCHAR2(100))
        End
        FROM bp_ae.lw_membertiers mt
        inner join lw_tiers t on mt.tierid = t.tierid
        WHERE mt.memberid = vc.ipcode
        AND SYSDATE BETWEEN mt.fromdate AND mt.todate
        AND ROWNUM = 1)-- Tier Status
        , CAST(p.a_totalpoints  as NVARCHAR2(80))-- Points Balance
        , CAST(p.a_pointstonextreward  as NVARCHAR2(80))-- Points Needed for Next Reward
        , CAST(p.a_bracurrentpurchased  as NVARCHAR2(80))-- Number of Bras Purchased
        , CAST( 5-(mod(p.a_bracurrentpurchased,5))  as NVARCHAR2(80))-- Credits to Next Free Bra
        , CAST(p.a_jeansrollingbalance  as NVARCHAR2(80))-- Number of Jeans Purchased
        , CAST( 5-(mod(p.a_jeansrollingbalance,5))  as NVARCHAR2(80))-- Credits to Next Free Jean
        , (SELECT  CAST( count(mr.id) as NVARCHAR2(80))
        FROM lw_memberrewards mr
        inner join lw_rewardsdef r on mr.rewarddefid = r.id
        WHERE mr.memberid = vc.ipcode
        AND r.name = 'AEO Rewards $5 Reward'
        AND mr.fulfillmentdate is null
        AND mr.expiration &gt; sysdate) -- Number of Active $5 off Reward
        , (SELECT  CAST( count(mr.id) as NVARCHAR2(80))
        FROM lw_memberrewards mr
        inner join lw_rewardsdef r on mr.rewarddefid = r.id
        WHERE mr.memberid = vc.ipcode
        AND r.name = 'B5G1 Jean Reward'
        AND mr.fulfillmentdate is null
        AND mr.expiration &gt; sysdate) -- Number of Active Free Jeans Reward
        , (SELECT  CAST(count(mr.id) as NVARCHAR2(80))
        FROM lw_memberrewards mr
        inner join lw_rewardsdef r on mr.rewarddefid = r.id
        WHERE mr.memberid = vc.ipcode
        AND r.name = 'B5G1 Jean Reward'
        AND mr.fulfillmentdate is null
        AND mr.expiration &gt; sysdate)-- Number of Active Free Bra Reward
        , CAST( ''  as NVARCHAR2(100))-- COMMUNICATION_ID
        , CAST( ''  as NVARCHAR2(100))-- COMM_PLAN_ID
        , CAST( ''  as NVARCHAR2(100))-- COLLATERAL_ID
        , CAST( ''  as NVARCHAR2(100))-- PACKAGE_ID
        , CAST( ''  as NVARCHAR2(100))-- STEP_ID
        , CAST( ''  as NVARCHAR2(100))-- MESSAGE_ID
        , CAST( ''  as NVARCHAR2(100))-- SEG_ID
        , CAST( ''  as NVARCHAR2(100))-- SEG_NM
        , CAST( ''  as NVARCHAR2(100))-- AAP_FLAG
        , CAST( md.a_cardtype   as NVARCHAR2(80))-- CARD_TYPE
        , CAST( ''  as NVARCHAR2(100))-- RUN ID
        , CAST( ''  as NVARCHAR2(100))-- Lead Key ID
        , CAST( ''  as NVARCHAR2(100))-- Site URL
        , CAST( ''  as NVARCHAR2(100))-- Enable Passbook Pass
        , CAST( ''  as NVARCHAR2(100))-- Timestamp
        From lw_loyaltymember lm
        INNER JOIN lw_virtualcard vc on lm.ipcode = vc.ipcode and vc.isprimary = 1
        INNER JOIN ats_memberdetails md on lm.ipcode = md.a_ipcode
        LEFT JOIN ats_memberpointbalances p on vc.ipcode = p.a_ipcode
        Where 1=1
        And lm.lastactivitydate &gt; add_months(sysdate, -12)
        And md.a_emailaddress Is Not Null
        AND (add_months(sysdate,-156) - 1) &gt; lm.birthdate
        AND lm.firstname is not null
        AND lm.memberstatus = 1
        AND AE_ISINPILOT(md.a_extendedplaycode) = 1 -- AEO-Point Conversion
        <!--AND md.a_pendingemailverification = 0 -->   <!-- AEO-724 changes here -->
        AND md.a_languagepreference in (0, 1)
        AND (md.a_employeecode is null or md.a_employeecode = 0)
        AND md.a_stateorprovince not in ('AB','BC','MB','NB','NL','NT','NS','NU','ON','PE','SK','YT','QC')
        ORDER BY rownumber

      </QueryString>
      <Fields>
		<Field Name="DELIVERY_CHANNEL" Type="String" />
		<Field Name="CUSTOMER_NBR" Type="String" />
		<Field Name="LOYALTY_NUMBER" Type="String" />
		<Field Name="EMAIL" Type="String" />
		<Field Name="MOBILE_NUMBER" Type="String" />
		<Field Name="FNAME" Type="String" />
		<Field Name="LNAME" Type="String" />
		<Field Name="ADDRESS1" Type="String" />
		<Field Name="ADDRESS2" Type="String" />
		<Field Name="CITY" Type="String" />
		<Field Name="STATE" Type="String" />
		<Field Name="ZIP" Type="String" />
		<Field Name="COUNTRY" Type="String" />
		<Field Name="N3_DIGIT_REWARDS_CODE" Type="String" />
		<Field Name="N20_DIGIT_REWARD_CODE" Type="String" />
		<Field Name="REWARD_TYPE" Type="String" />
		<Field Name="REWARD_EXP_DATE" Type="String" />
		<Field Name="EID" Type="String" />
		<Field Name="CAMPAIGN_ID" Type="String" />
		<Field Name="LANGUAGE_PREFERENCE" Type="String" />
		<Field Name="GENDER" Type="String" />
		<Field Name="BIRTHDATE" Type="String" />
		<Field Name="STORE_LOYALTY" Type="String" />
		<Field Name="TIER_STATUS" Type="String" />
		<Field Name="POINTS_BALANCE" Type="String" />
		<Field Name="POINTS_NEEDED_FOR_NEXT_REWARD" Type="String" />
		<Field Name="NUMBER_OF_BRAS_PURCHASED" Type="String" />
		<Field Name="CREDITS_TO_NEXT_FREE_BRA" Type="String" />
		<Field Name="NUMBER_OF_JEANS_PURCHASED" Type="String" />
		<Field Name="CREDITS_TO_NEXT_FREE_JEAN" Type="String" />
		<Field Name="NUMBER_OF_ACTIVE_5_OFF_REWARD" Type="String" />
		<Field Name="NUMBER_OF_ACTIVE_FREE_JEANS" Type="String" />
		<Field Name="NUMBER_OF_ACTIVE_FREE_BRA" Type="String" />
		<Field Name="COMMUNICATION_ID" Type="String" />
		<Field Name="COMM_PLAN_ID" Type="String" />
		<Field Name="COLLATERAL_ID" Type="String" />
		<Field Name="PACKAGE_ID" Type="String" />
		<Field Name="STEP_ID" Type="String" />
		<Field Name="MESSAGE_ID" Type="String" />
		<Field Name="SEG_ID" Type="String" />
		<Field Name="SEG_NM" Type="String" />
		<Field Name="AAP_FLAG" Type="String" />
		<Field Name="CARD_TYPE" Type="String" />
		<Field Name="RUN_ID" Type="String" />
		<Field Name="LEAD_KEY_ID" Type="String" />
		<Field Name="SITE_URL" Type="String" />
		<Field Name="ENABLE_PASSBOOK_PASS" Type="String" />
		<Field Name="TIMESTAMP" Type="String" />
      </Fields>
    </SimpleDatabaseInput>
  </InputProvider>
  <!-- Output provider -->
  <OutputProvider>
    <DelimetedFileOutput CollectionName="VendorEmailRewards" RecordName="VendorEmailReward" FileName="AEORW_EM_RWState_{$date(format=yyyyMMddhhmmss)}.txt" DataInAttributes="false"  Delimiter="|" OutputFolder="E:\americaneagle\Files\Outbound">
      <FieldMap>
		<Field Name="DELIVERY_CHANNEL" Length="100" />
		<Field Name="CUSTOMER_NBR" Length="100" />
		<Field Name="LOYALTY_NUMBER" Length="100" />
		<Field Name="EMAIL" Length="100" />
		<Field Name="MOBILE_NUMBER" Length="100" />
		<Field Name="FNAME" Length="100" />
		<Field Name="LNAME" Length="100" />
		<Field Name="ADDRESS1" Length="100" />
		<Field Name="ADDRESS2" Length="100" />
		<Field Name="CITY" Length="100" />
		<Field Name="STATE" Length="100" />
		<Field Name="ZIP" Length="100" />
		<Field Name="COUNTRY" Length="100" />
		<Field Name="N3_DIGIT_REWARDS_CODE" Length="100" />
		<Field Name="N20_DIGIT_REWARD_CODE" Length="100" />
		<Field Name="REWARD_TYPE" Length="100" />
		<Field Name="REWARD_EXP_DATE" Length="100" />
		<Field Name="EID" Length="100" />
		<Field Name="CAMPAIGN_ID" Length="100" />
		<Field Name="LANGUAGE_PREFERENCE" Length="100" />
		<Field Name="GENDER" Length="100" />
		<Field Name="BIRTHDATE" Length="100" />
		<Field Name="STORE_LOYALTY" Length="100" />
		<Field Name="TIER_STATUS" Length="100" />
		<Field Name="POINTS_BALANCE" Length="100" />
		<Field Name="POINTS_NEEDED_FOR_NEXT_REWARD" Length="100" />
		<Field Name="NUMBER_OF_BRAS_PURCHASED" Length="100" />
		<Field Name="CREDITS_TO_NEXT_FREE_BRA" Length="100" />
		<Field Name="NUMBER_OF_JEANS_PURCHASED" Length="100" />
		<Field Name="CREDITS_TO_NEXT_FREE_JEAN" Length="100" />
		<Field Name="NUMBER_OF_ACTIVE_5_OFF_REWARD" Length="100" />
		<Field Name="NUMBER_OF_ACTIVE_FREE_JEANS" Length="100" />
		<Field Name="NUMBER_OF_ACTIVE_FREE_BRA" Length="100" />
		<Field Name="COMMUNICATION_ID" Length="100" />
		<Field Name="COMM_PLAN_ID" Length="100" />
		<Field Name="COLLATERAL_ID" Length="100" />
		<Field Name="PACKAGE_ID" Length="100" />
		<Field Name="STEP_ID" Length="100" />
		<Field Name="MESSAGE_ID" Length="100" />
		<Field Name="SEG_ID" Length="100" />
		<Field Name="SEG_NM" Length="100" />
		<Field Name="AAP_FLAG" Length="100" />
		<Field Name="CARD_TYPE" Length="100" />
		<Field Name="RUN_ID" Length="100" />
		<Field Name="LEAD_KEY_ID" Length="100" />
		<Field Name="SITE_URL" Length="100" />
		<Field Name="ENABLE_PASSBOOK_PASS" Length="100" />
		<Field Name="TIMESTAMP" Length="100" />
      </FieldMap>
    </DelimetedFileOutput>
  </OutputProvider>
</DAPDirectives>