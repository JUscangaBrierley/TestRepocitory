<?xml version="1.0" encoding="utf-8"?>
<DAPDirectives xmlns="http://www.brierley.com/DAPFileProcessing">
  <!-- General Configuration Parameters -->
  <DAPConfiguration>
    <Organization>AmericanEagle</Organization>
	<Environment>DevelopmentBline</Environment>
    <DAPDataType>MemberAttributeSets</DAPDataType>
    <DateConversionFormat></DateConversionFormat>
    <TrimStrings>true</TrimStrings>
    <EmailInformation>
      <SMTPServer>cypwebmail.brierleyweb.com</SMTPServer>
      <SenderEmail>aejobs@brierley.com</SenderEmail>
      <SenderDisplayName>AE DAP Processor</SenderDisplayName>
      <RecepientEmail>aerewards_support@brierley.com</RecepientEmail>
      <Subject>AE DAP-JuneShorts Promo Processor</Subject>
    </EmailInformation>
    <DoNotProcess>false</DoNotProcess>
  </DAPConfiguration>
  <!-- Configuration parameters for message acquisition -->
  
  <!-- Configuration parameters for message acquisition -->	
  <InputProvider MessageProcessingScheme="Batch" DebugOutputPath="E:\AmericanEagle\Logs">
    <SimpleDatabaseInput CollectionName="TransactionInfos" RecordName="TransactionInfo">
 <QueryString>
	select RowKey,LoyaltyIdNumber from ( 
            Select distinct(thAudience.headerrowkey) as RowKey,thAudience.loyaltynumber as LoyaltyIdNumber,(
                 select SUM(td.a_dtlquantity) from bp_ae.ats_txndetailitem td
                 where 1=1
                 and td.a_txnheaderid = thAudience.orgtxnheaderid
                 and td.a_dtltypeid = 1
                 and td.a_dtlclearanceitem = 0
                 and td.a_excludequalifiedpurchase &lt;&gt; 1
                 and td.a_dtlclasscode in
                 (
                     SELECT t.Column_Value AS Classcode
                     FROM TABLE(Stringtotable((select cc.value from bp_ae.lw_clientconfiguration cc where cc.ckey='BonusPointsShortsJune2019'),';')) t
                 )
            ) AS OrgQaItems,
            (
                 select SUM(tdr.a_dtlquantity) from bp_ae.ats_txndetailitem tdr
                 where 1=1
                 and tdr.a_txnheaderid = thAudience.rettxnheaderid
                 and tdr.a_dtltypeid = 2
                 and tdr.a_dtlclearanceitem = 0
                 and tdr.a_excludequalifiedpurchase &lt;&gt;  1
                 and tdr.a_dtlclasscode in
                 (
                     SELECT t1.Column_Value AS Classcode
                     FROM TABLE(Stringtotable((select cc.value from bp_ae.lw_clientconfiguration cc where cc.ckey='BonusPointsShortsJune2019'),';')) t1
                 )
            ) curQaItems
            From(
               select
               distinct (dh.txnheaderid) as rettxnheaderid, orght.a_txnheaderid as orgtxnheaderid,vc.loyaltyidnumber as loyaltynumber, vc.ipcode,ht.a_rowkey as headerrowkey
               from bp_ae.stage_txndetailheader dh
               inner join bp_Ae.Ats_Txnheader ht on ht.a_txnheaderid = dh.txnheaderid
               inner join bp_ae.ats_txndetailitem dt on dt.a_txnheaderid = dh.txnheaderid
               inner join bp_ae.lw_virtualcard vc on vc.vckey = dh.vckey
               inner join bp_Ae.Ats_Txnheader orght on orght.a_txnnumber = dt.a_txnoriginaltxnnumber and orght.a_ordernumber = dt.a_txnoriginalordernumber
               and dt.a_txnoriginalstoreid = orght.a_txnstoreid     and orght.a_txndate = dt.a_txnoriginaltxndate
               inner join bp_ae.lw_pointtransaction pt on pt.rowkey = orght.a_rowkey
               inner join bp_ae.lw_pointevent pe on pe.pointeventid = pt.pointeventid
               inner join bp_ae.lw_memberpromotion mp on mp.memberid = vc.ipcode and mp.code='shortsbonus_june_2019' 
               where 1=1
               and ht.a_excludepointaccrual &lt;&gt; 1 
               and pe.name = 'June 2019 Shorts Bonus' and pt.points > 0 
            ) thAudience
        ) where curQaItems=OrgQaItems
 </QueryString>
      <Fields>
			<Field Name="RowKey" Type="String" />
			<Field Name="LoyaltyIdNumber" Type="String" />
      </Fields>
	   </SimpleDatabaseInput>
  </InputProvider>
  <!-- Output provider -->
  <OutputProvider>
    <CustomOutput>
      <TypeName>AmericanEagle.SDK.OutputProviders.RunTransactionRulesDAP</TypeName>
      <AssemblyName>AmericanEagle.SDK.dll</AssemblyName>
	   <Parameters>
         <Parameter Name="Threads" Value="8"/>
        <Parameter Name="Rules" Value="June 2019 Shorts Bonus - Return"/>
		</Parameters>
    </CustomOutput>
  </OutputProvider>
</DAPDirectives>